#include <minix/syslib.h>
#include <minix/drivers.h>
#include <minix/com.h>
#include <minix/sysutil.h>
#include "mouse.h"
#include "i8042.h"
#include "keyboard.h"

static int mouse_hook = 2;
unsigned char packet[3]="";

int mouse_subscribe_int(void){

	//Save original hook ID for the irq_set
	int originalHook=mouse_hook;

	//Subscribe mouse interrupts
	if(sys_irqsetpolicy(MOUSE_IRQ, IRQ_REENABLE|IRQ_EXCLUSIVE, &mouse_hook) != OK || sys_irqenable(&mouse_hook) != OK)
		return -1;

	return originalHook;
}

int mouse_unsubscribe_int(){

	//Unsubscribe mouse interrupts
	if(sys_irqdisable(&mouse_hook) != OK || sys_irqrmpolicy(&mouse_hook) != OK)
		return 1;

	return 0;
}

int mouse_enable_data_report(){

	if(kbc_write(KBC_CMD_REG, BYTE_TO_MOUSE)){
		printf("Error in mouse_enable_stream_mode()-BYTE TO MOUSE\n");
		return 1;
	}

	if(kbc_write(KBC_CMD_REG, ENABLE_DATA_REPORT)){
		printf("Error in mouse_enable_stream_mode()-ENABLE DATA REPORT\n");
		return 1;
	}

	return 0;
}

int mouse_set_stream_mode(){

	if(kbc_write(KBC_CMD_REG, BYTE_TO_MOUSE)){
		printf("Error in mouse_enable_stream_mode()-BYTE TO MOUSE\n");
		return 1;
	}

	if(kbc_write(KBC_CMD_REG, SET_STREAM_MODE)){
		printf("Error in mouse_enable_stream_mode()-ENABLE DATA REPORT\n");
		return 1;
	}

	return 0;
}

int mouse_set_remote_mode(){

	if(kbc_write(KBC_CMD_REG, BYTE_TO_MOUSE)){
		printf("Error in mouse_enable_stream_mode()-BYTE TO MOUSE\n");
		return 1;
	}

	if(kbc_write(KBC_CMD_REG, SET_REMOTE_MODE)){
		printf("Error in mouse_enable_stream_mode()-ENABLE DATA REPORT\n");
		return 1;
	}

	return 0;
}

void mouse_display_packet(unsigned char packet[]){

	printf("B1=0x%X ", packet[0]);
	printf("B2=0x%X ", packet[1]);
	printf("B3=0x%X ", packet[2]);
	printf("LB=%X ", (packet[0] & BIT(0)));
	printf("MB=%X ", (packet[0] & BIT(2)));
	printf("RB=%X ", (packet[0] & BIT(1)));
	printf("XOV=%X ", (packet[0] & BIT(6)));
	printf("YOV=%X ", (packet[0] & BIT(7)));
	printf("X=%X ", packet[1]);
	printf("Y=%X\n\n", packet[2]);

}





